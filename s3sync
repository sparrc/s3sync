#!/bin/bash
set -eou pipefail

SYNC_DIR=$(cat "$HOME/.s3sync/config.json" | jq -r .syncdir)
BUCKET=$(cat "$HOME/.s3sync/config.json" | jq -r .bucket)

if [ ! -f "$HOME/.s3sync/ts" ]; then
    echo 0 > "$HOME/.s3sync/ts"
fi

if ! aws s3 ls "s3://$BUCKET/ts"; then
    aws s3 cp "$HOME/.s3sync/ts" "s3://$BUCKET/ts"
fi

while true
do
    NOW=$(date -u "+%s")
    # get latest timestamp from remote:
    aws s3 cp "s3://$BUCKET/ts" "$HOME/.s3sync/ts_remote" --quiet
    TS_REMOTE=$(cat "$HOME/.s3sync/ts_remote")
    TS_LOCAL=$(cat "$HOME/.s3sync/ts")
    if [ "$TS_REMOTE" -gt "$TS_LOCAL" ]; then
        echo "$(date -u +%FT%TZ) Remote bucket contents are newer, downloading contents."
        cp "$HOME/.s3sync/ts_remote" "$HOME/.s3sync/ts"
        aws s3 sync "s3://$BUCKET/sync" "$SYNC_DIR" --delete --no-progress
    else
        diff=$(aws s3 sync "$SYNC_DIR" "s3://$BUCKET/sync" --delete --storage-class INTELLIGENT_TIERING --no-progress)
        if [[ "$diff" != "" ]]; then
            echo "$diff"
            # we made a change, update timestamps
            echo "$(date -u +%FT%TZ) Local directory changes uploaded, updating remote timestamp."
            echo "$NOW" > "$HOME/.s3sync/ts"
            aws s3 cp "$HOME/.s3sync/ts" "s3://$BUCKET/ts" --no-progress
            cp "$HOME/.s3sync/ts" "$HOME/.s3sync/ts_remote"
        fi
    fi
    sleep 60
done

